# Context Preservation Rules - Healthcare DSM Implementation
# Based on: Matriz de Depend√™ncia e Contextualiza√ß√£o para LLMs

## üìã Context Preservation Checklist

### ‚úÖ Mandatory Context Elements
Every documentation file MUST include:

#### 1. DSM Header Tags
```html
<!-- DSM:DOMAIN:primary|secondary COMPLEXITY:level DEPS:dependency_type -->
<!-- DSM:L3:technical_level L4:specificity TEMPORAL:time_context -->
<!-- DSM:HEALTHCARE:domain_specific_context -->
<!-- DSM:PERFORMANCE:metrics_and_targets -->
<!-- DSM:COMPLIANCE:regulatory_requirements -->
```

#### 2. Dependency Matrix Section
```yaml
DSM_MATRIX:
  depends_on:
    - [list of direct dependencies]
  provides_to:
    - [list of components that depend on this]
  integrates_with:
    - [list of integration points]
  performance_contracts:
    - [SLA and performance requirements]
  compliance_requirements:
    - [regulatory and compliance needs]
```

### üè• Healthcare-Specific Context Requirements

#### PHI/PII Handling Context
- **REQUIRED**: Always tag functions handling patient data
- **REQUIRED**: Include data minimization context
- **REQUIRED**: Document consent requirements
- **REQUIRED**: Preserve audit trail requirements

**Example:**
```elixir
# DSM:HEALTHCARE:phi_handling LGPD:consentimento_obrigatorio
def process_patient_data(patient_data) do
  # CONTEXT: This function handles PHI - LGPD Art. 11 compliance required
  # AUDIT: All patient data access logged automatically
  # CONSENT: Verify explicit consent before processing
```

#### Clinical Decision Support Context
- **REQUIRED**: Tag medical algorithms with evidence level
- **REQUIRED**: Include FDA/ANVISA approval status
- **REQUIRED**: Document clinical validation requirements
- **REQUIRED**: Preserve performance benchmarks

**Example:**
```elixir
# DSM:HEALTHCARE:clinical_support EVIDENCE:level_II_rct ANVISA:approved
def analyze_medical_claim(claim_text) do
  # CONTEXT: Clinical algorithm based on Level II evidence (RCT studies)
  # VALIDATION: ANVISA approved for Brazilian clinical use
  # PERFORMANCE: Must complete analysis within 5s SLA
```

### üîê Security Context Preservation

#### Zero Trust Context
- **REQUIRED**: All access decisions must include trust score context
- **REQUIRED**: Policy engine references must be preserved
- **REQUIRED**: Continuous verification context required

**Example:**
```elixir
# DSM:SECURITY:zero_trust NIST:sp_800_207 TRUST_SCORE:required
def authorize_medical_access(subject, resource, context) do
  # CONTEXT: Zero Trust authorization - NIST SP 800-207 compliant
  # TRUST_SCORE: Minimum score 85 for patient data access
  # CONTINUOUS: Trust score re-evaluated every 5 minutes
```

#### Post-Quantum Cryptography Context
- **REQUIRED**: Algorithm specifications (Kyber/Dilithium variants)
- **REQUIRED**: Security level justification (NIST levels 1,3,5)
- **REQUIRED**: Performance impact documentation

**Example:**
```elixir
# DSM:SECURITY:pqc ALGORITHM:kyber768 NIST_LEVEL:3 PERFORMANCE:+60%
def encrypt_patient_record(record, public_key) do
  # CONTEXT: Post-quantum encryption using ML-KEM-768 (NIST Level 3)
  # JUSTIFICATION: 192-bit security for long-term PHI protection
  # PERFORMANCE: 60% overhead acceptable for critical healthcare data
```

### üìä Performance Context Requirements

#### SLA Context Preservation
- **REQUIRED**: Response time targets with healthcare justification
- **REQUIRED**: Concurrency requirements for clinical workflows
- **REQUIRED**: Availability targets for patient safety

**Example:**
```elixir
# DSM:PERFORMANCE:sla RESPONSE:<50ms CONCURRENCY:2M+ AVAILABILITY:99.99%
def retrieve_patient_summary(patient_id) do
  # CONTEXT: Clinical workflow requires <50ms response for patient safety
  # JUSTIFICATION: Emergency care cannot wait for slow data retrieval
  # MONITORING: Alerts triggered if response exceeds 45ms
```

### üîó Integration Context Rules

#### FHIR R4 Context
- **REQUIRED**: Resource type and validation requirements
- **REQUIRED**: Brazilian healthcare profile compliance
- **REQUIRED**: Interoperability requirements

**Example:**
```typescript
// DSM:INTEGRATION:fhir_r4 PROFILE:br_core VALIDATION:mandatory
function validatePatientResource(resource: any) {
  // CONTEXT: FHIR R4 Patient resource with Brazilian profile extensions
  // COMPLIANCE: CFM/CRP professional validation required
  // INTEROPERABILITY: Must support HL7 message exchange
}
```

#### MCP Protocol Context
- **REQUIRED**: Tool capabilities and limitations
- **REQUIRED**: Healthcare-specific security requirements
- **REQUIRED**: Performance and scalability context

**Example:**
```typescript
// DSM:INTEGRATION:mcp TOOLS:healthcare_specific SECURITY:zero_trust
async function analyzeLGPDRisk(content: string) {
  // CONTEXT: MCP tool for real-time LGPD compliance analysis
  // SECURITY: Zero Trust validation required for all requests
  // PERFORMANCE: Must complete analysis within 30s timeout
}
```

## üîÑ Context Update Rules

### When to Update Context
1. **Code Changes**: Any modification requires context review
2. **Performance Changes**: SLA modifications require documentation update
3. **Compliance Changes**: Regulatory updates require immediate context updates
4. **Dependency Changes**: Version upgrades require DSM matrix updates
5. **Integration Changes**: New integrations require relationship documentation

### Context Validation Checklist
- [ ] DSM tags are complete and accurate
- [ ] Dependency matrix reflects actual relationships
- [ ] Healthcare context includes all compliance requirements
- [ ] Performance context includes current SLAs
- [ ] Security context includes all protection measures
- [ ] Integration context includes all external dependencies

### Context Consistency Rules
1. **Cross-Reference Validation**: All referenced components must exist
2. **Performance Alignment**: SLAs must be consistent across components
3. **Compliance Alignment**: All components must meet same regulatory requirements
4. **Security Alignment**: Security levels must be consistent across integrations
5. **Version Alignment**: All dependencies must specify compatible versions

## üìà Quality Metrics for Context Preservation

### Completeness Metrics
- **DSM Tag Coverage**: 100% of healthcare files must have complete DSM tags
- **Matrix Coverage**: 100% of components must have dependency matrix
- **Healthcare Context**: 100% of PHI/PII handling must include healthcare tags
- **Performance Context**: 100% of critical paths must include SLA context
- **Compliance Context**: 100% of regulatory requirements must be documented

### Consistency Metrics
- **Cross-Reference Accuracy**: 0 broken references between components
- **SLA Consistency**: 0 conflicting performance requirements
- **Compliance Consistency**: 0 conflicting regulatory interpretations
- **Security Consistency**: 0 mismatched security requirements
- **Version Consistency**: 0 incompatible dependency versions

### Currency Metrics
- **Update Frequency**: Context reviewed every 30 days minimum
- **Change Tracking**: All context changes linked to code changes
- **Validation Frequency**: Automated validation runs daily
- **Compliance Review**: Regulatory context reviewed quarterly
- **Performance Review**: SLA context reviewed monthly

## üö® Critical Context Preservation Failures

### Automatic Failure Triggers
1. **Missing Healthcare Tags**: Any PHI/PII handling without compliance tags
2. **Missing Performance Context**: Any critical path without SLA documentation
3. **Missing Dependency Matrix**: Any component without relationship documentation
4. **Inconsistent Compliance**: Any conflicting regulatory requirements
5. **Broken References**: Any reference to non-existent components

### Recovery Procedures
1. **Immediate**: Stop deployment if critical context missing
2. **Assessment**: Evaluate impact on patient safety and compliance
3. **Remediation**: Update missing context before proceeding
4. **Validation**: Verify context completeness and consistency
5. **Documentation**: Record failure and prevention measures

---

**This document defines the mandatory context preservation rules for the healthcare WASM-Elixir stack. All code changes must comply with these requirements to ensure patient safety, regulatory compliance, and system reliability.**