#!/bin/bash

# Universal Stack Detection Script
# Automatically detects technology stack, framework, and architecture patterns

echo "ðŸ” UNIVERSAL STACK DETECTION"
echo "=========================="

PROJECT_PATH="${1:-$(pwd)}"
cd "$PROJECT_PATH" || exit 1

echo "ðŸ“ Project Path: $PROJECT_PATH"
echo ""

# Language Detection based on file extensions
echo "ðŸ”§ PRIMARY LANGUAGE DETECTION:"
echo "------------------------------"

declare -A languages
languages["js"]="JavaScript"
languages["ts"]="TypeScript"
languages["py"]="Python"
languages["ex"]="Elixir"
languages["exs"]="Elixir"
languages["rb"]="Ruby"
languages["go"]="Go"
languages["rs"]="Rust"
languages["java"]="Java"
languages["php"]="PHP"
languages["cpp"]="C++"
languages["c"]="C"
languages["cs"]="C#"

# Count files by extension
for ext in "${!languages[@]}"; do
    count=$(find . -name "*.${ext}" -not -path "./node_modules/*" -not -path "./vendor/*" -not -path "./.git/*" | wc -l)
    if [ "$count" -gt 0 ]; then
        echo "  ${languages[$ext]}: $count files (.${ext})"
    fi
done

echo ""

# Framework Detection
echo "ðŸš€ FRAMEWORK DETECTION:"
echo "----------------------"

# JavaScript/TypeScript frameworks
if [ -f "package.json" ]; then
    echo "  ðŸ“¦ Node.js project detected (package.json)"

    # Check for specific frameworks
    if grep -q "\"react\"" package.json; then
        echo "  âš›ï¸  React detected"
    fi
    if grep -q "\"vue\"" package.json; then
        echo "  ðŸ–– Vue.js detected"
    fi
    if grep -q "\"angular\"" package.json; then
        echo "  ðŸ…°ï¸  Angular detected"
    fi
    if grep -q "\"express\"" package.json; then
        echo "  ðŸš‚ Express.js detected"
    fi
    if grep -q "\"next\"" package.json; then
        echo "  â–² Next.js detected"
    fi
    if grep -q "\"nuxt\"" package.json; then
        echo "  ðŸ’š Nuxt.js detected"
    fi
fi

# Python frameworks
if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] || [ -f "Pipfile" ]; then
    echo "  ðŸ Python project detected"

    if grep -q "Django" requirements.txt 2>/dev/null || grep -q "django" requirements.txt 2>/dev/null; then
        echo "  ðŸ¦„ Django detected"
    fi
    if grep -q "Flask" requirements.txt 2>/dev/null || grep -q "flask" requirements.txt 2>/dev/null; then
        echo "  ðŸŒ¶ï¸  Flask detected"
    fi
    if grep -q "FastAPI" requirements.txt 2>/dev/null || grep -q "fastapi" requirements.txt 2>/dev/null; then
        echo "  âš¡ FastAPI detected"
    fi
fi

# Elixir/Phoenix
if [ -f "mix.exs" ]; then
    echo "  ðŸ§ª Elixir project detected (mix.exs)"
    if grep -q "phoenix" mix.exs; then
        echo "  ðŸ”¥ Phoenix detected"
    fi
fi

# Ruby/Rails
if [ -f "Gemfile" ]; then
    echo "  ðŸ’Ž Ruby project detected (Gemfile)"
    if grep -q "rails" Gemfile; then
        echo "  ðŸ›¤ï¸  Ruby on Rails detected"
    fi
fi

# Go
if [ -f "go.mod" ]; then
    echo "  ðŸ¹ Go project detected (go.mod)"
    if grep -q "gin" go.mod; then
        echo "  ðŸ¸ Gin detected"
    fi
    if grep -q "echo" go.mod; then
        echo "  ðŸ“¢ Echo detected"
    fi
fi

# Java
if [ -f "pom.xml" ]; then
    echo "  â˜• Java/Maven project detected (pom.xml)"
    if grep -q "spring" pom.xml; then
        echo "  ðŸŒ± Spring detected"
    fi
elif [ -f "build.gradle" ]; then
    echo "  â˜• Java/Gradle project detected (build.gradle)"
fi

# Rust
if [ -f "Cargo.toml" ]; then
    echo "  ðŸ¦€ Rust project detected (Cargo.toml)"
    if grep -q "axum" Cargo.toml; then
        echo "  ðŸª“ Axum detected"
    fi
    if grep -q "actix-web" Cargo.toml; then
        echo "  ðŸ•¸ï¸  Actix-web detected"
    fi
fi

# PHP
if [ -f "composer.json" ]; then
    echo "  ðŸ˜ PHP project detected (composer.json)"
    if grep -q "laravel" composer.json; then
        echo "  ðŸŽ¼ Laravel detected"
    fi
    if grep -q "symfony" composer.json; then
        echo "  ðŸŽµ Symfony detected"
    fi
fi

echo ""

# Architecture Pattern Detection
echo "ðŸ—ï¸  ARCHITECTURE PATTERNS:"
echo "-------------------------"

# Directory structure analysis
if [ -d "src" ] || [ -d "lib" ]; then
    echo "  ðŸ“‚ Source code organization: Structured"
fi

if [ -d "controllers" ] || [ -d "views" ] || [ -d "models" ]; then
    echo "  ðŸ›ï¸  MVC pattern detected"
fi

if [ -d "components" ] || [ -d "hooks" ] || [ -d "context" ]; then
    echo "  ðŸ§© Component-based architecture"
fi

if [ -d "services" ] || [ -d "repositories" ] || [ -d "entities" ]; then
    echo "  ðŸ¢ Service layer architecture"
fi

if [ -d "microservices" ] || [ -f "docker-compose.yml" ] && grep -q "services:" docker-compose.yml 2>/dev/null; then
    echo "  ðŸ”¬ Microservices architecture detected"
fi

if [ -f "serverless.yml" ] || [ -f "sam-template.yaml" ]; then
    echo "  â˜ï¸  Serverless architecture detected"
fi

echo ""

# Database Detection
echo "ðŸ’¾ DATABASE DETECTION:"
echo "---------------------"

if [ -f "prisma/schema.prisma" ]; then
    echo "  ðŸ”· Prisma ORM detected"
fi

if find . -name "*.sql" -o -name "*migration*" | head -1 | grep -q .; then
    echo "  ðŸ—ƒï¸  SQL database detected (migration files found)"
fi

if grep -r "mongodb\|mongoose" . 2>/dev/null | head -1 | grep -q .; then
    echo "  ðŸ¥¬ MongoDB detected"
fi

if grep -r "redis" . 2>/dev/null | head -1 | grep -q .; then
    echo "  ðŸ”´ Redis detected"
fi

echo ""

# Project Type Detection
echo "ðŸ“‹ PROJECT TYPE DETECTION:"
echo "-------------------------"

if [ -f "package.json" ] && grep -q "\"type\": \"module\"" package.json; then
    echo "  ðŸ“¦ ES Module project"
fi

if [ -d "public" ] || [ -d "static" ] || [ -d "assets" ]; then
    echo "  ðŸŒ Web application"
fi

if grep -r "express\|koa\|fastify" package.json 2>/dev/null | grep -q .; then
    echo "  ðŸ”— Backend API/Server"
fi

if [ -f "bin" ] || [ -d "cmd" ] || grep -q "#!/usr/bin/env" $(find . -maxdepth 2 -type f 2>/dev/null) 2>/dev/null; then
    echo "  ðŸ’» CLI application"
fi

if grep -r "library\|package" package.json 2>/dev/null | grep -q .; then
    echo "  ðŸ“š Library/Package"
fi

echo ""
echo "âœ… Stack detection complete!"
echo "Use this information to customize the diagnostic methodology."